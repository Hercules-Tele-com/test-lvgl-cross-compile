<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaf Telemetry</title>
    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #333;
        }

        h1 {
            font-size: 2em;
            font-weight: 300;
            margin-bottom: 10px;
        }

        .status {
            font-size: 0.9em;
            color: #888;
        }

        .status.connected::before {
            content: '‚óè ';
            color: #4CAF50;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #242424;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .card h2 {
            font-size: 1.2em;
            font-weight: 400;
            margin-bottom: 20px;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .metric {
            margin-bottom: 16px;
        }

        .metric:last-child {
            margin-bottom: 0;
        }

        .metric-label {
            font-size: 0.85em;
            color: #888;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 2em;
            font-weight: 300;
            line-height: 1;
        }

        .metric-unit {
            font-size: 0.9em;
            color: #888;
            margin-left: 4px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            padding: 8px 0;
            border-bottom: 1px solid #333;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-row-label {
            color: #888;
            font-size: 0.9em;
        }

        .metric-row-value {
            font-size: 1.1em;
            font-weight: 500;
        }

        .soc-display {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .soc-value {
            font-size: 4em;
            font-weight: 200;
            line-height: 1;
            color: #4CAF50;
        }

        .soc-label {
            font-size: 0.9em;
            color: #888;
            margin-top: 8px;
        }

        .warning {
            color: #ff9800;
        }

        .error {
            color: #f44336;
        }

        .good {
            color: #4CAF50;
        }

        #map {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        /* Status indicators */
        .status-indicators {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #2a2a2a;
            border-radius: 20px;
            transition: all 0.3s ease;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .status-dot.online {
            background: #4CAF50;
            box-shadow: 0 0 8px #4CAF50;
        }

        .status-dot.offline {
            background: #f44336;
            box-shadow: 0 0 8px #f44336;
        }

        .status-dot.unknown {
            background: #666;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .soc-value {
                font-size: 3em;
            }

            .status-indicators {
                flex-wrap: wrap;
                gap: 10px;
            }

            .status-indicator {
                font-size: 0.8em;
                padding: 4px 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Nissan Leaf Telemetry</h1>
            <div class="status" id="status">Connecting...</div>
            <div class="status-indicators">
                <div class="status-indicator">
                    <div class="status-dot unknown" id="battery-status"></div>
                    <span>Battery</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot unknown" id="motor-status"></div>
                    <span>Motor</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot unknown" id="gps-status"></div>
                    <span>GPS</span>
                </div>
            </div>
        </header>

        <!-- Battery Section -->
        <div class="grid">
            <div class="card" style="grid-column: span 2;">
                <h2>‚ö° EMBOO Battery</h2>
                <div class="soc-display">
                    <div class="soc-value" id="soc">--</div>
                    <div class="soc-label">State of Charge</div>
                </div>
                <div class="metric-row">
                    <span class="metric-row-label">Voltage</span>
                    <span class="metric-row-value"><span id="voltage">--</span> V</span>
                </div>
                <div class="metric-row">
                    <span class="metric-row-label">Current</span>
                    <span class="metric-row-value"><span id="current">--</span> A</span>
                </div>
                <div class="metric-row">
                    <span class="metric-row-label">Power</span>
                    <span class="metric-row-value"><span id="power">--</span> kW</span>
                </div>
                <div class="metric-row">
                    <span class="metric-row-label">Cell Range</span>
                    <span class="metric-row-value"><span id="cellRange">--</span> mV</span>
                </div>
                <div class="metric-row">
                    <span class="metric-row-label">Temperature</span>
                    <span class="metric-row-value"><span id="batteryTemp">--</span> ¬∞C</span>
                </div>
            </div>

            <!-- Motor Section -->
            <div class="card">
                <h2>üîß Motor</h2>
                <div class="metric-row">
                    <span class="metric-row-label">RPM</span>
                    <span class="metric-row-value" id="rpm">--</span>
                </div>
                <div class="metric-row">
                    <span class="metric-row-label">Torque</span>
                    <span class="metric-row-value"><span id="torque">--</span> Nm</span>
                </div>
                <div class="metric-row">
                    <span class="metric-row-label">Motor Temp</span>
                    <span class="metric-row-value"><span id="motorTemp">--</span> ¬∞C</span>
                </div>
                <div class="metric-row">
                    <span class="metric-row-label">Inverter Temp</span>
                    <span class="metric-row-value"><span id="inverterTemp">--</span> ¬∞C</span>
                </div>
                <div class="metric-row">
                    <span class="metric-row-label">DC Bus</span>
                    <span class="metric-row-value"><span id="dcBus">--</span> V</span>
                </div>
            </div>

            <!-- Vehicle Section -->
            <div class="card">
                <h2>üöó Vehicle</h2>
                <div class="metric">
                    <div class="metric-label">Speed</div>
                    <div class="metric-value"><span id="speed">--</span> <span class="metric-unit">km/h</span></div>
                </div>
            </div>

            <!-- GPS Section -->
            <div class="card" style="grid-column: span 2;">
                <h2>üìç GPS Location</h2>
                <div id="map"></div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px;">
                    <div class="metric-row">
                        <span class="metric-row-label">Altitude</span>
                        <span class="metric-row-value"><span id="altitude">--</span> m</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-row-label">Satellites</span>
                        <span class="metric-row-value" id="satellites">--</span>
                    </div>
                    <div class="metric-row">
                        <span class="metric-row-label">Heading</span>
                        <span class="metric-row-value"><span id="heading">--</span>¬∞</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Info -->
        <div class="card">
            <h2>‚ÑπÔ∏è System</h2>
            <div class="metric-row">
                <span class="metric-row-label">Hostname</span>
                <span class="metric-row-value" id="hostname">--</span>
            </div>
            <div class="metric-row">
                <span class="metric-row-label">Last Update</span>
                <span class="metric-row-value" id="lastUpdate">--</span>
            </div>
        </div>
    </div>

    <script>
        let socket = null;
        let map = null;
        let marker = null;

        // Initialize map
        function initMap() {
            // Default to Nairobi, Kenya (user's approximate location from GPS logs)
            const defaultLat = -1.4149;
            const defaultLon = 35.1244;

            map = L.map('map').setView([defaultLat, defaultLon], 15);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Add marker for vehicle position
            marker = L.marker([defaultLat, defaultLon]).addTo(map);
            marker.bindPopup('Waiting for GPS fix...').openPopup();
        }

        function updateMapPosition(lat, lon, heading, satellites) {
            if (!map || !marker) return;

            // Update marker position
            marker.setLatLng([lat, lon]);

            // Update popup
            const popupText = `
                Lat: ${lat.toFixed(6)}<br>
                Lon: ${lon.toFixed(6)}<br>
                Heading: ${heading}¬∞<br>
                Satellites: ${satellites}
            `;
            marker.bindPopup(popupText);

            // Center map on new position
            map.setView([lat, lon], map.getZoom());
        }

        // Initialize WebSocket
        function initWebSocket() {
            socket = io();

            socket.on('connect', () => {
                updateStatus(true);
                socket.emit('subscribe_realtime');
            });

            socket.on('disconnect', () => {
                updateStatus(false);
            });

            socket.on('realtime_update', (data) => {
                updateDashboard(data);
            });
        }

        function updateStatus(connected) {
            const status = document.getElementById('status');
            if (connected) {
                status.textContent = 'Connected';
                status.classList.add('connected');
            } else {
                status.textContent = 'Disconnected';
                status.classList.remove('connected');
            }
        }

        function updateDashboard(data) {
            // Battery data
            if (data.battery) {
                const b = data.battery;
                updateElement('soc', Math.round(b.soc_percent || 0) + '%');
                updateElement('voltage', (b.voltage || 0).toFixed(1));
                updateElement('current', (b.current || 0).toFixed(1));

                const power = b.power_kw || ((b.voltage || 0) * (b.current || 0) / 1000);
                updateElement('power', power.toFixed(2));

                const temp = b.temp_avg || b.temp_high || b.temperature || 0;
                updateElement('batteryTemp', Math.round(temp));

                if (b.cell_voltage_min !== undefined && b.cell_voltage_max !== undefined) {
                    const minV = Math.round((b.cell_voltage_min || 0) * 1000);
                    const maxV = Math.round((b.cell_voltage_max || 0) * 1000);
                    updateElement('cellRange', `${minV} - ${maxV}`);
                }

                // Color code SOC
                const socEl = document.getElementById('soc');
                if (socEl) {
                    const soc = b.soc_percent || 0;
                    if (soc < 20) {
                        socEl.className = 'soc-value error';
                    } else if (soc < 40) {
                        socEl.className = 'soc-value warning';
                    } else {
                        socEl.className = 'soc-value good';
                    }
                }
            }

            // Motor data
            if (data.motor) {
                const m = data.motor;
                updateElement('rpm', m.rpm || 0);
                updateElement('torque', m.torque_actual || 0);
                updateElement('motorTemp', m.temp_stator ? Math.round(m.temp_stator) : '--');
                updateElement('dcBus', m.voltage_dc_bus || '--');
            }

            // Inverter data
            if (data.inverter) {
                updateElement('inverterTemp', Math.round(data.inverter.temp_inverter || 0));
            }

            // GPS data
            if (data.gps) {
                const g = data.gps;

                // Speed from GPS
                if (g.speed_kmh !== undefined) {
                    updateElement('speed', g.speed_kmh.toFixed(1));
                }

                // Altitude
                if (g.altitude !== undefined) {
                    updateElement('altitude', Math.round(g.altitude));
                }

                // Satellites
                if (g.satellites !== undefined) {
                    updateElement('satellites', g.satellites);
                }

                // Heading
                if (g.heading !== undefined) {
                    updateElement('heading', Math.round(g.heading));
                }

                // Update map if we have valid position
                if (g.latitude !== undefined && g.longitude !== undefined) {
                    updateMapPosition(
                        g.latitude,
                        g.longitude,
                        g.heading || 0,
                        g.satellites || 0
                    );
                }
            } else {
                updateElement('speed', '--');
            }

            // System info
            updateElement('hostname', data.hostname || '--');
            if (data.timestamp) {
                const date = new Date(data.timestamp);
                updateElement('lastUpdate', date.toLocaleTimeString());
            }

            // Update status indicators
            if (data.status_indicators) {
                updateStatusIndicator('battery-status', data.status_indicators.battery);
                updateStatusIndicator('motor-status', data.status_indicators.motor);
                updateStatusIndicator('gps-status', data.status_indicators.gps);
            }
        }

        function updateStatusIndicator(elementId, status) {
            const element = document.getElementById(elementId);
            if (element) {
                // Remove all status classes
                element.classList.remove('online', 'offline', 'unknown');
                // Add the current status class
                element.classList.add(status || 'unknown');
            }
        }

        function updateElement(id, value) {
            const el = document.getElementById(id);
            if (el) el.textContent = value;
        }

        // Fetch initial data
        function fetchInitialData() {
            fetch('/api/status')
                .then(response => response.json())
                .then(data => updateDashboard(data))
                .catch(error => console.error('Error:', error));
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            initWebSocket();
            fetchInitialData();
        });
    </script>
</body>
</html>
